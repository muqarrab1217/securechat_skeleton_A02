"""Classic DH helpers + Trunc16(SHA256(Ks)) derivation.""" 
import secrets
import hashlib

RFC3526_2048_HEX = (
    "FFFFFFFFFFFFFFFFC90FDAA22168C234C4C6628B80DC1CD129024E08"
    "8A67CC74020BBEA63B139B22514A08798E3404DDEF9519B3CD"
    "3A431B302B0A6DF25F14374FE1356D6D51C245E485B576625E7EC6"
    "F44C42E9A637ED6B0BFF5CB6F406B7ED"
    "EE386BFB5A899FA5AE9F24117C4B1FE649286651ECE65381FFFFFFFFFFFFFFFF"
)

RFC3526_2048 = int (
    "FFFFFFFFFFFFFFFFC90FDAA22168C234C4C6628B80DC1CD129024E08"
    "8A67CC74020BBEA63B139B22514A08798E3404DDEF9519B3CD"
    "3A431B302B0A6DF25F14374FE1356D6D51C245E485B576625E7EC6"
    "F44C42E9A637ED6B0BFF5CB6F406B7ED"
    "EE386BFB5A899FA5AE9F24117C4B1FE649286651ECE65381FFFFFFFFFFFFFFFF", 16
)

P = RFC3526_2048
G = 2

def generatePrivateKey(bitLength: int = 256):
    return secrets.randbits(bitLength)

def publicFromPrivate(priv: int):
    return pow(G, priv, P)

def deriveSharedKey(priv: int, peerPub: int):
    shared = pow(peerPub, priv, P)
    sharedBytes = shared.to_bytes((shared.bit_length() + 7) // 8, "big")
    digest = hashlib.sha256(sharedBytes).digest() 
    return digest[:16]